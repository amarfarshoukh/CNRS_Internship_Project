<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Incident Monitor - Lebanon</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
    #sidebar {
      padding: 12px;
      border-right: 1px solid #eee;
      overflow: auto;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #map { height: 100%; width: 100%; }
    .section-title { font-weight: 700; margin-top: 8px; }
    .legend { margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px; align-items: center; }
    .stat { font-size: 12px; color: #666; margin-top: 8px; }
    .controls { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .controls button, .controls input[type="text"], .controls select {
      padding: 6px 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer;
    }
    .controls input[type="text"] { flex: 1; min-width: 160px; }
    #filter-container { display: flex; gap: 4px; align-items: center; margin-top: 6px; }
    #filter-select { flex: 0 0 120px; padding: 6px; border-radius: 8px; border: 1px solid #ddd; background: #fff; }
    #show-all, #none-btn { flex: 0 0 80px; padding: 6px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .footer { font-size: 12px; color: #444; margin-top: 12px; }
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <h2>Incident Monitor – Lebanon</h2>
      <div class="stat"><span id="last-updated">Loading…</span></div>

      <div class="controls">
        <button id="refresh">Refresh</button>
        <input id="search" type="text" placeholder="Search text/city…" />
      </div>

      <div class="section-title">Filter by type</div>
      <div id="filter-container">
        <select id="filter-select">
          <option value="" disabled selected>Filter by type</option>
        </select>
        <button id="show-all">Show All</button>
        <button id="none-btn">None</button>
      </div>

      <div class="section-title">Legend</div>
      <div class="legend" id="legend"></div>

      <div class="footer">
        Tiles © OpenStreetMap contributors. Data from your JSON pipeline.
      </div>
    </aside>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
const map = L.map('map', { minZoom: 7, maxZoom: 18 }).setView([33.9, 35.86], 8);
const lebanonBounds = L.latLngBounds([[32.8, 34.9], [34.9, 36.9]]);
map.setMaxBounds(lebanonBounds);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const TYPE_ICONS = {
  vehicle_accident: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/caraccident.png",
  shooting: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/shooting.png",
  protest: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/protest.png",
  fire: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/fire.png",
  earthquake: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/earthquake.png",
  flood: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/flood.png",
  tree_down: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/treedown.png",
  airstrike: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/war.png",
  collapse: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/collapse.png",
  pollution: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/pollution.png",
  epidemic: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/epidemic.png",
  medical: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/hospital-building.png",
  explosion: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/bomb.png",
  other: "C:/Users/user/OneDrive - Lebanese University/Documents/GitHub/Incident_Project/icons/other.png"
};

const ALL_TYPES = Object.keys(TYPE_ICONS);
let activeTypes = new Set([...ALL_TYPES]); // default all
let searchTerm = '';
const cluster = L.markerClusterGroup().addTo(map);
const filterSelect = document.getElementById('filter-select');
const showAllBtn = document.getElementById('show-all');
const noneBtn = document.getElementById('none-btn');
const legendDiv = document.getElementById('legend');
let allItems = [];

// Populate dropdown
ALL_TYPES.forEach(t => {
  const opt = document.createElement('option');
  opt.value = t;
  opt.textContent = t;
  filterSelect.appendChild(opt);
});

// Dropdown change
filterSelect.addEventListener('change', () => {
  const selected = filterSelect.value;
  if (selected) activeTypes = new Set([selected]);
  render();
});

// Show All button
showAllBtn.addEventListener('click', () => {
  activeTypes = new Set([...ALL_TYPES]);
  filterSelect.value = ""; 
  render();
});

// None button
noneBtn.addEventListener('click', () => {
  activeTypes.clear();
  filterSelect.value = ""; 
  render();
});

// Legend
ALL_TYPES.forEach(t => {
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.alignItems = 'center';
  row.innerHTML = `<img src="${TYPE_ICONS[t]}" style="width:18px;height:18px;margin-right:6px;"><span>${t}</span>`;
  legendDiv.appendChild(row);
});

// Refresh and search
document.getElementById('refresh').onclick = () => refresh();
document.getElementById('search').addEventListener('input', e => {
  searchTerm = e.target.value.toLowerCase().trim();
  render();
});

// Marker creation
function markerFor(item) {
  if (!item.coordinates || item.coordinates.length !== 2) return null;
  const lat = item.coordinates[0];
  const lon = item.coordinates[1];

  const icon = L.icon({
    iconUrl: TYPE_ICONS[item.incident_type] || TYPE_ICONS['other'],
    iconSize: [30, 30],
    iconAnchor: [15, 30],
    popupAnchor: [0, -30]
  });

  const marker = L.marker([lat, lon], { icon: icon });
  const popupHtml = `
    <div style="min-width:220px">
      <strong>${item.incident_type}</strong><br>
      <b>City:</b> ${item.city}<br>
      <b>Date:</b> ${item.date}<br>
      <b>Channel:</b> ${item.channel}<br>
      <b>Summary:</b> ${item.details?.summary || '' }
    </div>`;
  marker.bindPopup(popupHtml);
  return marker;
}

function matchesFilters(item) {
  if (!item.coordinates || item.coordinates.length !== 2) return false;
  if (activeTypes.size === 0) return false; 
  if (!activeTypes.has(item.incident_type || 'other')) return false;
  if (searchTerm) {
    const hay = (item.details?.summary || '') + ' ' + (item.city || '') + ' ' + (item.incident_type || '');
    return hay.toLowerCase().includes(searchTerm);
  }
  return true;
}

function render() {
  cluster.clearLayers();
  const shown = [];
  allItems.forEach(it => {
    if (matchesFilters(it)) {
      const m = markerFor(it);
      if (m) cluster.addLayer(m);
      shown.push(it);
    }
  });
  document.getElementById('last-updated').textContent =
    `${shown.length} shown / ${allItems.length} total — ${new Date().toLocaleTimeString()}`;
}

async function refresh() {
  try {
    const res = await fetch('http://127.0.0.1:5000/incidents');
    const data = await res.json();
    allItems = data.incidents.map(i => ({
      incident_type: i.incident_type,
      city: i.location,
      coordinates: i.coordinates,
      details: i.details,
      date: i.date,
      channel: i.channel
    }));
    render();
  } catch(e) {
    console.error('Failed to load incidents:', e);
  }
}

// Default: show all incidents
activeTypes = new Set([...ALL_TYPES]);

refresh();
setInterval(refresh, 30000);
  </script>
</body>
</html>
