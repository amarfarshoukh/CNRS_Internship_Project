<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Incident Monitor - Lebanon</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
    #sidebar { padding: 12px; border-right: 1px solid #eee; overflow: auto; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    .section-title { font-weight: 700; margin-top: 8px; }
    .legend { margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px; align-items: center; }
    .stat { font-size: 12px; color: #666; margin-top: 8px; }
    .controls { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .controls button, .controls input[type="text"], .controls select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; }
    .controls input[type="text"] { flex: 1; min-width: 160px; }
    #filter-container { display: flex; gap: 4px; align-items: center; margin-top: 6px; }
    #filter-select { flex: 0 0 120px; padding: 6px; border-radius: 8px; border: 1px solid #ddd; background: #fff; }
    #show-all, #none-btn { flex: 0 0 80px; padding: 6px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .footer { font-size: 12px; color: #444; margin-top: 12px; }

    /* Hide spider lines */
    .leaflet-marker-spider-line {
      display: none !important;
    }

    /* Bot styling */
    #ask-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 14px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }
    #ask-btn:hover { background: #333; }

    #bot-modal {
      display: none;
      position: fixed;
      bottom: 70px;
      right: 20px;
      width: 320px;
      background: #fff;
      border: 2px solid #000;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9999;
      font-family: sans-serif;
      max-height: 420px;
      overflow: hidden;
    }
    #bot-modal-header {
      padding: 10px;
      font-weight: bold;
      border-bottom: 1px solid #000;
      background: #f8f8f8;
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #bot-close {
      background: transparent;
      border: none;
      font-size: 16px;
      font-weight: 700;
      color: #c00;
      cursor: pointer;
      padding: 4px 6px;
      line-height: 1;
    }
    #bot-modal-content {
      padding: 10px;
      overflow-y: auto;
      max-height: 360px;
    }
    .bot-q, .bot-main-q, .bot-sub-btn {
      width: 100%;
      padding: 8px;
      margin: 8px 0 4px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fafafa;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }
    .bot-q:hover, .bot-main-q:hover, .bot-sub-btn:hover { background: #f0f0f0; }

    .inline-form {
      border: 1px dashed #ddd;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
      background: #fff;
    }
    .inline-form .row { display: grid; grid-template-columns: 1fr; gap: 6px; }
    .inline-form input, .inline-form select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 6px; }
    .inline-form button { padding: 8px; border-radius: 8px; border: 1px solid #000; background: #000; color: #fff; cursor: pointer; }
    .inline-form button:hover { background: #333; }

    #bot-answer { margin-top: 10px; font-size: 14px; color: #000; padding: 8px; border-top: 1px solid #eee; }
    .hint { font-size: 12px; color: #666; margin-top: 4px; }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <h2>Incident Monitor – Lebanon</h2>
      <div class="stat"><span id="last-updated">Loading…</span></div>

      <div class="controls">
        <button id="refresh">Refresh</button>
        <input id="search" type="text" placeholder="Search text/city…" />
      </div>

      <div class="section-title">Filter by type</div>
      <div id="filter-container">
        <select id="filter-select">
          <option value="" disabled selected>Filter by type</option>
        </select>
        <button id="show-all">Show All</button>
        <button id="none-btn">None</button>
      </div>

      <div class="section-title">Legend</div>
      <div class="legend" id="legend"></div>

      <div class="footer">
        Tiles © OpenStreetMap contributors. Data from your JSON pipeline.
      </div>
    </aside>
    <div id="map"></div>
  </div>

  <!-- Ask Me Bot -->
  <button id="ask-btn">اسألني!</button>
  <div id="bot-modal">
    <div id="bot-modal-header">
      روبوت الحوادث
      <button id="bot-close" aria-label="Close">×</button>
    </div>
    <div id="bot-modal-content">
      <div class="bot-topic">
        <button class="bot-main-q">الحوادث اليوم</button>
        <div class="bot-sub-q hidden">
          <button class="bot-sub-btn" data-q="vehicle_today">عدد حوادث المركبات اليوم</button>
          <button class="bot-sub-btn" data-q="total_today">إجمالي الحوادث اليوم</button>
        </div>
      </div>

      <div class="bot-topic">
        <button class="bot-main-q">حسب المدينة</button>
        <div class="bot-sub-q hidden">
          <button class="bot-sub-btn" data-q="city_all">عدد الحوادث في مدينة</button>
          <button class="bot-sub-btn" data-q="city_today">عدد الحوادث اليوم في مدينة</button>
        </div>
      </div>

      <div class="bot-topic">
        <button class="bot-main-q">حسب النوع</button>
        <div class="bot-sub-q hidden">
          <button class="bot-sub-btn" data-q="type_all">عدد الحوادث حسب النوع</button>
          <button class="bot-sub-btn" data-q="type_today">عدد الحوادث اليوم حسب النوع</button>
          <button class="bot-sub-btn" data-q="type_city">عدد الحوادث حسب النوع والمدينة</button>
        </div>
      </div>

      <div class="bot-topic">
        <button class="bot-main-q">حسب المدة</button>
        <div class="bot-sub-q hidden">
          <button class="bot-sub-btn" data-q="range_any">عدد الحوادث بين تاريخين</button>
          <button class="bot-sub-btn" data-q="range_type">عدد الحوادث حسب النوع بين تاريخين</button>
          <button class="bot-sub-btn" data-q="range_city">عدد الحوادث في مدينة بين تاريخين</button>
        </div>
      </div>

      <div id="bot-answer" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Datalists -->
  <datalist id="type-options"></datalist>
  <datalist id="city-options"></datalist>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // === Map setup ===
    const map = L.map('map', { minZoom: 7, maxZoom: 18 }).setView([33.9, 35.86], 8);
    const lebanonBounds = L.latLngBounds([[32.8, 34.9], [34.9, 36.9]]);
    map.setMaxBounds(lebanonBounds);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const TYPE_ICONS = {
      vehicle_accident: "icons/caraccident.png",
      shooting: "icons/shooting.png",
      protest: "icons/protest.png",
      fire: "icons/fire.png",
      earthquake: "icons/earthquake.png",
      flood: "icons/flood.png",
      tree_down: "icons/treedown.png",
      airstrike: "icons/war.png",
      collapse: "icons/collapse.png",
      pollution: "icons/pollution.png",
      epidemic: "icons/epidemic.png",
      medical: "icons/hospital-building.png",
      explosion: "icons/bomb.png",
      other: "icons/other.png"
    };

    const ALL_TYPES = Object.keys(TYPE_ICONS);
    let activeTypes = new Set([...ALL_TYPES]);
    let searchTerm = '';

    const cluster = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true
    });
    map.addLayer(cluster);

    const filterSelect = document.getElementById('filter-select');
    const showAllBtn = document.getElementById('show-all');
    const noneBtn = document.getElementById('none-btn');
    const legendDiv = document.getElementById('legend');
    let allItems = [];

    // Populate dropdown
    ALL_TYPES.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      filterSelect.appendChild(opt);
    });

    // Legend
    ALL_TYPES.forEach(t => {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.innerHTML = `<img src="${TYPE_ICONS[t]}" style="width:18px;height:18px;margin-right:6px;"><span>${t}</span>`;
      legendDiv.appendChild(row);
    });

    // Marker creation
    function markerFor(item) {
      if (!item.coordinates || item.coordinates.length !== 2) return null;
      const [lat, lon] = item.coordinates;
      const icon = L.icon({
        iconUrl: TYPE_ICONS[item.incident_type] || TYPE_ICONS['other'],
        iconSize: [30,30],
        iconAnchor: [15,30],
        popupAnchor: [0,-30]
      });
      const marker = L.marker([lat, lon], { icon });
      const popupHtml = `<div style="min-width:220px">
          <strong>${item.incident_type}</strong><br>
          <b>City:</b> ${item.city}<br>
          <b>Date:</b> ${item.date}<br>
          <b>Channel:</b> ${item.channel}<br>
          <b>Summary:</b> ${item.details?.summary || '' }
        </div>`;
      marker.bindPopup(popupHtml);
      return marker;
    }

    function matchesFilters(item) {
      if (!item.coordinates || item.coordinates.length !== 2) return false;
      if (activeTypes.size === 0) return false;
      if (!activeTypes.has(item.incident_type || 'other')) return false;
      if (searchTerm) {
        const hay = (item.details?.summary || '') + ' ' + (item.city || '') + ' ' + (item.incident_type || '');
        return hay.toLowerCase().includes(searchTerm);
      }
      return true;
    }

    function render() {
      cluster.clearLayers();
      const shown = [];
      allItems.forEach(it => {
        if (matchesFilters(it)) {
          const m = markerFor(it);
          if (m) cluster.addLayer(m);
          shown.push(it);
        }
      });
      document.getElementById('last-updated').textContent =
        `${shown.length} shown / ${allItems.length} total — ${new Date().toLocaleTimeString()}`;
    }

    async function refresh() {
      try {
        const res = await fetch('http://127.0.0.1:5000/incidents');
        const data = await res.json();
        allItems = data.incidents.map(i => ({
          incident_type: i.incident_type,
          city: i.location,
          coordinates: i.coordinates,
          details: i.details,
          date: i.date,
          channel: i.channel
        }));
        updateCityDatalist();
        render();
      } catch(e) {
        console.error('Failed to load incidents:', e);
      }
    }

    document.getElementById('search').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim().toLowerCase();
        if (!query) return;

        const matched = allItems.filter(item =>
          item.city && item.city.toLowerCase().includes(query) &&
          item.coordinates && item.coordinates.length === 2
        );

        if (matched.length > 0) {
          const latlngs = matched.map(i => [i.coordinates[0], i.coordinates[1]]);
          const bounds = L.latLngBounds(latlngs);
          map.fitBounds(bounds.pad(0.3));

          matched.slice(0,5).forEach(i => {
            const m = markerFor(i);
            if (m) m.addTo(map).openPopup();
          });
        } else {
          alert("No incidents found for this city.");
        }

        render();
      }
    });

    // Filter events
    filterSelect.addEventListener('change', () => {
      const selected = filterSelect.value;
      if (selected) activeTypes = new Set([selected]);
      render();
    });
    showAllBtn.addEventListener('click', () => { activeTypes = new Set([...ALL_TYPES]); filterSelect.value = ""; render(); });
    noneBtn.addEventListener('click', () => { activeTypes.clear(); filterSelect.value = ""; render(); });

    // Default refresh
    activeTypes = new Set([...ALL_TYPES]);
    document.getElementById('refresh').onclick = () => refresh();
    refresh();
    setInterval(refresh, 30000);

    // === Bot logic ===
    const askBtn = document.getElementById('ask-btn');
    const modal = document.getElementById('bot-modal');
    const answerDiv = document.getElementById('bot-answer');
    const closeBtn = document.getElementById('bot-close');

    askBtn.addEventListener('click', () => modal.style.display = (modal.style.display==='block')?'none':'block');
    closeBtn.addEventListener('click', () => modal.style.display = 'none');

    const typeOptions = document.getElementById('type-options');
    ALL_TYPES.forEach(t => { const o = document.createElement('option'); o.value=t; typeOptions.appendChild(o); });

    function updateCityDatalist() {
      const cityOptions = document.getElementById('city-options');
      cityOptions.innerHTML = '';
      const uniq = [...new Set(allItems.map(i=>i.city).filter(Boolean))].sort();
      uniq.forEach(c=>{ const o=document.createElement('option'); o.value=c; cityOptions.appendChild(o); });
    }

    function todayISO() { return new Date().toISOString().slice(0,10); }
    const countWhere = pred => allItems.reduce((acc,it)=>acc+(pred(it)?1:0),0);

    document.querySelectorAll('.bot-main-q').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sub = btn.nextElementSibling;
        sub.classList.toggle('hidden');
      });
    });

    // Sub-button handling
    document.querySelectorAll('.bot-sub-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.dataset.q;
        answerDiv.innerHTML = '';
        if(key==='vehicle_today'){ answerDiv.textContent = `عدد حوادث المركبات اليوم: ${countWhere(i=>i.incident_type==='vehicle_accident' && i.date===todayISO())}`; }
        else if(key==='total_today'){ answerDiv.textContent = `إجمالي الحوادث اليوم: ${countWhere(i=>i.date===todayISO())}`; }
        else if(key==='city_all' || key==='city_today' || key==='type_all' || key==='type_today' || key==='type_city' || key==='range_any' || key==='range_type' || key==='range_city'){
          // Render inline form
          renderInlineForm(key);
        }
      });
    });

    function renderInlineForm(key){
      const div = document.createElement('div');
      div.className='inline-form';
      if(key==='city_all'){
        div.innerHTML = `<div class="row"><label>اختر المدينة</label><input list="city-options" id="city-inp"><button onclick="cityAll()">احسب</button></div>`;
      } else if(key==='city_today'){
        div.innerHTML = `<div class="row"><label>اختر المدينة</label><input list="city-options" id="city-inp"><button onclick="cityToday()">احسب</button></div>`;
      } else if(key==='type_all'){
        div.innerHTML = `<div class="row"><label>اختر النوع</label><input list="type-options" id="type-inp"><button onclick="typeAll()">احسب</button></div>`;
      } else if(key==='type_today'){
        div.innerHTML = `<div class="row"><label>اختر النوع</label><input list="type-options" id="type-inp"><button onclick="typeToday()">احسب</button></div>`;
      } else if(key==='type_city'){
        div.innerHTML = `<div class="row"><label>اختر النوع</label><input list="type-options" id="type-inp"><label>اختر المدينة</label><input list="city-options" id="city-inp"><button onclick="typeCity()">احسب</button></div>`;
      } else if(key==='range_any' || key==='range_type' || key==='range_city'){
        div.innerHTML = `<div class="row"><label>من تاريخ</label><input type="date" id="from-date"><label>الى تاريخ</label><input type="date" id="to-date">`+
          (key==='range_type' || key==='range_city'?'<label>اختر النوع</label><input list="type-options" id="type-inp">':'')+
          (key==='range_city' || key==='range_type'?'<label>اختر المدينة</label><input list="city-options" id="city-inp">':'')+
          `<button onclick="rangeCalc('${key}')">احسب</button></div>`;
      }
      answerDiv.appendChild(div);
    }

    // Inline form functions
    window.cityAll = () => {
      const val = document.getElementById('city-inp')?.value;
      const n = countWhere(i=>i.city===val);
      answerDiv.textContent = `عدد الحوادث في ${val}: ${n}`;
    };
    window.cityToday = () => {
      const val = document.getElementById('city-inp')?.value;
      const n = countWhere(i=>i.city===val && i.date===todayISO());
      answerDiv.textContent = `عدد الحوادث اليوم في ${val}: ${n}`;
    };
    window.typeAll = () => {
      const val = document.getElementById('type-inp')?.value;
      const n = countWhere(i=>i.incident_type===val);
      answerDiv.textContent = `عدد الحوادث من النوع ${val}: ${n}`;
    };
    window.typeToday = () => {
      const val = document.getElementById('type-inp')?.value;
      const n = countWhere(i=>i.incident_type===val && i.date===todayISO());
      answerDiv.textContent = `عدد الحوادث اليوم من النوع ${val}: ${n}`;
    };
    window.typeCity = () => {
      const typeVal = document.getElementById('type-inp')?.value;
      const cityVal = document.getElementById('city-inp')?.value;
      const n = countWhere(i=>i.incident_type===typeVal && i.city===cityVal);
      answerDiv.textContent = `عدد الحوادث من النوع ${typeVal} في ${cityVal}: ${n}`;
    };
    window.rangeCalc = (key) => {
      const from = document.getElementById('from-date')?.value;
      const to = document.getElementById('to-date')?.value;
      const typeVal = document.getElementById('type-inp')?.value;
      const cityVal = document.getElementById('city-inp')?.value;
      const n = countWhere(i=>{
        if(!i.date) return false;
        if(i.date<from || i.date>to) return false;
        if(key==='range_type' && i.incident_type!==typeVal) return false;
        if(key==='range_city' && i.city!==cityVal) return false;
        if(key==='range_city' && typeVal && i.incident_type!==typeVal) return false;
        return true;
      });
      answerDiv.textContent = `عدد الحوادث في النطاق الزمني: ${n}`;
    };
  </script>
</body>
</html>
